<?php TPL::output('global/header_meta.tpl.htm'); ?>

<div class="row">
    <div class="col-sm-2"></div>
    <div class="col-sm-8">
        <div class="card">
            <div class="login-block">
                <div class="card-header card-padding login-header p-b-0">
                    <a href="<?php echo base_url(); ?>" class="login-logo"></a>
                    <h1>新用户注册</h1>
                    <span class="pull-right">
                        已有账号？<a href="account/login/" class="c-lightblue">马上登录</a>
                    </span>
                </div>
                <div class="card-body card-padding">
                    <div class="login-form">
                        <form class="aw-register-form" action="account/ajax/register_process/" method="post" id="register_form">
                            <?php if ($this->icode) { ?><input type="hidden" name="icode" id="icode" value="<?php echo $this->icode; ?>" /><?php } ?>
                            <?php if ($this->return_url) { ?><input type="hidden" name="return_url" value="<?php echo $this->return_url; ?>" /><?php } ?>

                            <ul>
                                <li class="alert alert-danger hide error_message text-left">
                                    <i class="icon icon-delete"></i> <em></em>
                                </li>
                                <li class="m-b-20">
                                    <div class="form-group">
                                        <input class="aw-register-name form-control" type="text" name="user_name" placeholder="<?php _e('用户名'); ?>" tips="<?php _e('请输入一个 2-14 位的用户名');?>" errortips="<?php _e('用户名长度不符合');?>" value="" />
                                    </div>  
                                </li>
                                <li class="m-b-20">
                                    <input class="aw-register-email form-control" type="text" placeholder="<?php _e('邮箱'); ?>" name="email" tips="<?php _e('请输入你常用的电子邮箱作为你的账号'); ?>" value="<?php echo htmlspecialchars($_GET['email']); ?>" errortips="<?php _e('邮箱格式不正确'); ?>" />
                                </li>
                                <li class="m-b-20">
                                    <input class="aw-register-pwd form-control" type="password" name="password" placeholder="密码" tips="<?php _e('请输入 6-16 个字符,区分大小写'); ?>" errortips="<?php _e('密码不符合规则'); ?>" />
                                </li>
                                
                                <?php if (get_setting('register_seccode') == 'Y') { ?>
                                <li class="aw-register-verify m-b-20">
                                    <img class="pull-right" id="captcha" onclick="this.src = G_BASE_URL + '/account/captcha/' + Math.floor(Math.random() * 10000);" src="">

                                    <input type="text" class="form-control" name="seccode_verify" placeholder="<?php _e('验证码'); ?>" />
                                </li>
                                <?php } ?>
                                <li class="last">
                                    <div class="checkbox m-b-20">
                                        <label>
                                            <input type="checkbox" value="agree" name="agreement_chk" />
                                            <i class="input-helper"></i>
                                            我同意 <a href="javascript:;" class="aw-agreement-btn c-lightblue">《用户协议》</a>
                                        </label>
                                    </div>
                                </li>
                                <li class="clearfix">
                                    <button class="btn btn-lg btn-primary submit" onclick="AWS.ajax_post($('#register_form'), AWS.ajax_processer, 'error_message'); return false;"><?php _e('注册'); ?></button>
                                </li>
                            </ul>
                        </form>
                    </div>
                    
                    <div class="login-sns">
                        <div class="login-sns-title">
                            <h2>使用已有账号</h2>
                        </div>
                        
                        <ul class="sns-login-items">
                            <li><a class="bgm-blue" href="#"><i class="icon icon-qq"></i></a></li>
                            <li><a class="bgm-green" href="#"><i class="icon icon-wechat"></i></a></li>
                            <li><a class="bgm-red" href="#"><i class="icon icon-weibo"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-2"></div>
</div>

<script type="text/javascript">
$(document).ready(function ()
{
    $.get(G_BASE_URL + '/account/ajax/register_agreement/', function (result) { $('#register_agreement').html(result.err); }, 'json');

    $('.aw-agreement-btn').click(function()
    {
        if ($('.aw-register-agreement').is(':visible'))
        {
            $('.aw-register-agreement').hide();
        }
        else
        {
            $('.aw-register-agreement').show();
        }
    });

    $('.more-information-btn').click(function()
    {
        $('.more-information').fadeIn();
        $(this).parent().hide();
    });

    verify_register_form('#register_form');

    /* 注册页面验证 */
    function verify_register_form(element)
    {
        $(element).find('[type=text], [type=password]').on({
            focus : function()
            {
                var _this = $(this);
                var inputWrap = $(this).parent();
                if (typeof _this.attr('tips') != 'undefined' && _this.attr('tips') != '')
                {
                    inputWrap.find('.help-block').detach();
                    inputWrap.find('.form-control-feedback').detach();
                    inputWrap.addClass('has-warning').removeClass('has-error').removeClass('has-success').removeClass('has-feedback');
                    inputWrap.append('<small class="help-block">' + _this.attr('tips') + '</small>');
                }
            },
            blur : function()
            {
                var _this = $(this);
                var inputWrap = _this.parent();
                var helpBlock = inputWrap.find('.help-block');
                var feedbackBlock = inputWrap.find('.form-control-feedback');
                var inputValue = _this.val();
                var errorTips = _this.attr('errortips');
                var isValidValue = false;

                switch ($(this).attr('name'))
                {
                    case 'user_name' :
                        isValidValue = (inputValue.length >= 2 && inputValue.length <= 16);
                        if(isValidValue)
                        {
                            $.get(G_BASE_URL + '/account/ajax/check_username/username' + '-' + encodeURIComponent(inputValue), function (result)
                            {
                                if (result.errno == -1)
                                {
                                    isValidValue = false;
                                    errorTips = result.err;
                                }
                            }, 'json');
                        }
                    break;

                    case 'email' :
                        var emailreg = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;
                        isValidValue = emailreg.test(inputValue);
                    break;

                    case 'password' :
                        isValidValue = (inputValue.length >= 6 && inputValue.length <= 17);
                    break;
                    default :
                        errorTips = '';
                }

                helpBlock.detach();
                feedbackBlock.detach();
                inputWrap.removeClass('has-error').removeClass('has-warning').removeClass('has-success').removeClass('has-feedback');

                if(!isValidValue) {
                    inputWrap.addClass('has-error');
                    inputWrap.append('<small class="help-block">' + errorTips + '</small>');
                } else {
                    inputWrap.addClass('has-success').addClass('has-feedback');
                    inputWrap.append('<span class="md md-check form-control-feedback"></span>');
                }
            }
        });
    }

    // $('.select_area').LocationSelect({
    //     labels: ["<?php _e('请选择省份或直辖市'); ?>", "<?php _e('请选择城市'); ?>"],
    //     elements: document.getElementsByTagName("select"),
    //     detector: function () {
    //         this.select(["<?php echo $this->user_info['province']; ?>", "<?php echo $this->user_info['city']; ?>"]);
    //     },
    //     dataUrl: G_STATIC_URL + '/js/areas.js'
    // });
});
</script>

<?php TPL::output('global/footer.tpl.htm'); ?>
